<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AR Qu√≠mica ‚Äî Ranking</title>
<style>
  :root{--bg:#0b1020;--bg2:#0e1530;--ink:#E6ECFF;--muted:#A9B7FF;--card:#0f183a;--card2:#121f49;--line:#2e3a75;--accent:#7AE7FF;--accent2:#9D84FF;}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:var(--ink);
    background:radial-gradient(80rem 40rem at -10% -10%,#1a245f55,transparent 60%),
               radial-gradient(80rem 40rem at 110% 10%,#5320a84a,transparent 60%),
               linear-gradient(180deg,var(--bg),var(--bg2));
    min-height:100vh;display:flex;flex-direction:column}
  .hidden{display:none!important}
  .container{max-width:1100px;margin:0 auto;padding:22px 22px 120px;width:100%;flex:1;display:flex;flex-direction:column;min-height:0}
  header{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:10px 0 14px}
  .brand{display:flex;align-items:center;gap:14px;position:relative}
  .logo{width:42px;height:42px;border-radius:12px;background:conic-gradient(from 0deg,#7AE7FF,#9D84FF,#FF80E8,#75FFB2,#7AE7FF);box-shadow:0 6px 24px #0007;flex:0 0 42px;margin-right:10px}
  .title{margin:0;font-weight:800;font-size:clamp(18px,3.6vw,28px);line-height:1.1;white-space:nowrap}
  .title .grad{color:#fff}
  .cta{display:flex;gap:10px;flex-wrap:wrap}
  .btn{background:linear-gradient(90deg,#5BC0FF,#8C7CFF);color:white;border:none;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid var(--line);color:var(--ink)}
  .btn.small{padding:8px 12px;font-weight:600}
  .panel{background:linear-gradient(180deg,var(--card),var(--card2));border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 12px 40px #0007;margin-bottom:22px}
  .tag{display:inline-block;padding:6px 10px;border-radius:999px;background:#101842;border:1px solid var(--line);color:#A9B7FF;font-size:12px}
  .tablewrap{max-height:60vh;overflow:auto}
  table{width:100%;border-collapse:separate;border-spacing:0 10px}
  thead th{font-size:12px;color:#cbd6ff;font-weight:600;text-align:left;padding:0 10px}
  tbody tr{background:#101a44;border:1px solid var(--line)}
  tbody td{padding:12px 10px}
  tbody tr td:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
  tbody tr td:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}
  .rank{width:78px;text-align:left;font-weight:800}
  .name{font-weight:700}.score{font-weight:800}
  .input{background:#0f1941;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:10px 12px;outline:none;min-width:200px}
  .lb-head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
  .toast{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);background:#0f183f;border:1px solid var(--line);color:#d8e4ff;padding:10px 14px;border-radius:12px;box-shadow:0 10px 30px #0006;opacity:0;pointer-events:none}
  .toast.show{animation:toast 2.2s ease forwards}
  @keyframes toast{0%{opacity:0;transform:translateX(-50%) translateY(10px)}15%,85%{opacity:1;transform:translateX(-50%) translateY(0)}100%{opacity:0;transform:translateX(-50%) translateY(10px)}}
  .hint{font-size:12px;color:#b6c4ff}
  .overlay{position:fixed;inset:0;background:#0009;display:none;align-items:center;justify-content:center;padding:16px;z-index:40}
  .overlay.show{display:flex}
  .modal{width:min(980px,100%);max-height:90vh;overflow:auto}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#0f1941;font-weight:600;color:#cfe0ff}
  .combo-tools{display:flex;gap:8px;align-items:center;margin:8px 0}
  .combo-list{max-height:220px;overflow:auto;border:1px solid var(--line);border-radius:10px;padding:8px;background:#0f183f}
  .combo-item{display:flex;align-items:center;gap:8px;padding:6px 4px;border-radius:8px}
  .combo-item:hover{background:#0f214f}
  .dot{width:18px;height:18px;border-radius:50%}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#0f183f;font-size:11px;color:#cfe0ff}
  .tabs{display:flex;gap:8px;margin:10px 0 14px}
  .tab{border:1px solid var(--line);background:#0f1941;color:#dce6ff;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
  .tab.active{background:linear-gradient(90deg,#5BC0FF22,#8C7CFF22);border-color:#6d79ff}
  .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .cardLine{border:1px solid var(--line);border-radius:10px;padding:10px;background:#0f183f;display:flex;align-items:center;justify-content:space-between;gap:10px}
  .loadmore{display:flex;justify-content:center;margin-top:12px}
  .btn.more{background:transparent;border:1px solid var(--line);color:#dce6ff}
  .kv{display:grid;grid-template-columns:140px 1fr;gap:6px;font-size:14px}
  .kv b{color:#cfe0ff}
    .password-wrap{
    position:relative;
    flex:1 1 120px;
  }
  .password-wrap input{
    width:100%;
    padding-right:32px; /* espacio para el ojito */
  }
  .pwd-toggle{
    position:absolute;
    right:8px;
    top:50%;
    transform:translateY(-50%);
    border:none;
    background:transparent;
    color:var(--muted);
    cursor:pointer;
    font-size:16px;
    padding:0;
  }

</style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1 class="title">AR <span class="grad">Qu√≠mica</span></h1>
      </div>
      <div class="cta">
        <a class="btn" id="linkApp" href="#" download>Descargar App</a>
        <a class="btn ghost" id="linkPDF" href="./Tarjetas.pdf" download="Tarjetas.pdf">Tarjetas (PDF)</a>
        <button class="btn ghost" id="btnDocentes">Docentes</button>
      </div>
    </header>

    <section class="panel" style="margin-bottom:16px">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div><span class="tag">Desaf√≠os activos</span><h2 style="margin:8px 0 0">¬°Completa combinaciones a tiempo!</h2></div>
        <div class="hint">Se actualizan en vivo ¬∑ Cuenta regresiva por desaf√≠o</div>
      </div>
      <div id="activeChallenges" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px;margin-top:10px"></div>
    </section>

    <section class="panel">
      <div class="lb-head">
        <div>
          <div class="tag">Ranking de puntajes</div>
          <h2 style="margin:8px 0 0">Tabla de posiciones</h2>
          <div id="rankStatus" class="hint">Cargando‚Ä¶</div>
        </div>
      </div>
      <div class="tablewrap">
        <table>
          <thead><tr><th>#</th><th>Estudiante</th><th>Puntaje</th></tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div id="loadMoreWrap" class="loadmore hidden">
        <button id="btnMore" class="btn more">Ver m√°s (+50)</button>
      </div>
    </section>
  </div>

  <!-- MODAL DOCENTES -->
  <div class="overlay" id="ovl">
    <div class="panel modal">
      <div class="row">
        <div><span class="pill">Docentes</span> <strong style="margin-left:6px">Panel</strong></div>
        <button class="btn small ghost" id="closeOvl">Cerrar</button>
      </div>

      <div id="lockRow" class="row" style="gap:8px;margin:12px 0;flex-wrap:wrap">
        <input id="loginUser" class="input" style="min-width:140px" placeholder="Usuario" autocomplete="username" />
        <input id="loginPass" class="input" style="min-width:140px" placeholder="Contrase√±a" type="password" autocomplete="current-password" />
        <button class="btn small" id="btnUnlock">Iniciar sesi√≥n</button>
      </div>
      <div id="whoLine" class="hint hidden"></div>


      <div id="adminBox" class="hidden">
        <div class="tabs">
          <button class="tab active" id="tabCreate">Creador</button>
          <button class="tab" id="tabResults">Resultados</button>
        </div>

        <div id="creatorSection">
          <div class="panel" style="margin:0">
            <div class="tools" style="flex-wrap:wrap">
              <input id="dName" class="input" placeholder="Nombre del desaf√≠o (p. ej.: Reto 1: √ìxidos)" style="flex:1 1 260px" />
              <label class="input" style="display:flex;gap:8px;align-items:center;width:220px">
                <span style="white-space:nowrap">Puntos por combinaci√≥n</span>
                <input id="pts" type="number" min="1" value="100" style="width:80px;background:transparent;border:none;color:var(--ink);outline:none"/>
              </label>
              <label class="input" style="display:flex;gap:8px;align-items:center;width:200px">
                <span style="white-space:nowrap">Cantidad a exigir</span>
                <input id="count" type="number" min="1" value="5" style="width:70px;background:transparent;border:none;color:var(--ink);outline:none"/>
              </label>
              <select id="dur" class="input" style="width:200px">
                <option value="1h">1 hora</option><option value="3h">3 horas</option><option value="24h">24 horas</option>
                <option value="2d">2 d√≠as</option><option value="3d">3 d√≠as</option><option value="custom">Elegir fecha/hora‚Ä¶</option>
              </select>
              <input id="customUntil" class="input hidden" type="datetime-local" />
              <label class="input" style="display:flex;gap:8px;align-items:center;width:200px">
                <input id="expireOthers" type="checkbox" checked />
                <span style="white-space:nowrap">Expirar otros</span>
              </label>
            </div>

            <div class="combo-tools">
              <input id="comboSearch" class="input" placeholder="Buscar combinaci√≥n (ej. agua, NaCl, √≥xido)..." style="flex:1 1 260px" />
              <span class="hint">Resultados en vivo</span>
            </div>

            <p class="hint" style="margin:6px 0">Selecciona las combinaciones candidatas (de aqu√≠ se tomar√°n al azar seg√∫n ‚ÄúCantidad a exigir‚Äù).</p>
            <div id="comboList" class="combo-list"></div>

            <div class="tools" style="margin-top:12px">
              <button id="btnAddChallenge" class="btn small">Publicar desaf√≠o</button>
              <button id="btnDemo" class="btn small ghost">Cargar datos demo</button>
              <button id="btnClearAll" class="btn small ghost">Vaciar ranking</button>
            </div>

            <h3 style="margin:10px 0 6px">Administrar desaf√≠os publicados</h3>
            <div class="row" style="margin-bottom:8px">
              <div class="hint">Se consultan del servidor</div>
              <button id="btnRefreshChallenges" class="btn small ghost">Refrescar</button>
            </div>
            <div id="serverChallengeList" style="display:grid;grid-template-columns:1fr;gap:8px"></div>

            <div id="serverChallengeDetail" class="hidden" style="margin-top:12px">
              <button id="btnCloseDetail" class="btn small ghost" style="margin-bottom:8px">‚Üê Volver</button>
              <div id="detailHeader" class="panel" style="margin:0 0 10px"></div>
              <div class="panel" style="margin:0">
                <div class="row" style="margin-bottom:8px">
                  <h3 style="margin:0">Participantes de este desaf√≠o</h3>
                  <div class="hint">Ordenado por puntaje</div>
                </div>
                <div class="tablewrap" style="max-height:50vh">
                  <table>
                    <thead><tr><th>#</th><th>Estudiante</th><th>Puntaje</th><th>Curso</th></tr></thead>
                    <tbody id="tbodyChResults"></tbody>
                  </table>
                </div>
              </div>
            </div>

          </div>
        </div>

        <div id="resultsSection" class="hidden">
          <div class="panel" style="margin:0">
            <div class="row">
              <h3 style="margin:0">Resultados de desaf√≠os (local)</h3>
              <div class="hint">Vista de ejemplo sin servidor</div>
            </div>
            <div id="resultsIndex" style="display:grid;grid-template-columns:1fr;gap:8px;margin-top:10px"></div>

            <div id="resultDetail" class="hidden" style="margin-top:10px">
              <button id="btnBackResults" class="btn small ghost" style="margin-bottom:8px">‚Üê Volver</button>
              <div class="row" id="resultHeader"></div>
              <div class="tablewrap" style="margin-top:8px;max-height:50vh">
                <table>
                  <thead><tr><th>#</th><th>Estudiante</th><th>Puntaje</th><th>Curso</th></tr></thead>
                  <tbody id="tbodyResults"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <!-- Gesti√≥n de docentes (solo admin) -->
        <div id="usersSection" class="hidden">
          <h3 style="margin-top:16px">Gesti√≥n de docentes</h3>
          <p class="hint">Solo para el administrador: crear usuarios y activar/desactivar docentes.</p>

          <div class="panel" style="margin-top:8px">
            <div class="row" style="margin-bottom:8px">
              <strong>Nuevo docente</strong>
            </div>
            <div class="row" style="gap:8px;flex-wrap:wrap">
              <input id="newTeacherName" class="input" placeholder="Nombre completo" style="flex:1 1 160px" />
              <input id="newTeacherUser" class="input" placeholder="Usuario" style="flex:1 1 120px" />
<div class="password-wrap">
  <input id="newTeacherPass" class="input" placeholder="Contrase√±a" type="password" />
  <button type="button" id="toggleNewTeacherPass" class="pwd-toggle">üëÅ</button>
</div>

              <button id="btnCreateTeacher" class="btn small">Crear</button>
            </div>
          </div>

          <div class="panel" style="margin-top:10px">
            <div class="row" style="margin-bottom:8px">
              <strong>Usuarios registrados</strong>
              <button id="btnReloadUsers" class="btn small ghost">Refrescar</button>
            </div>
            <div id="usersList" class="tablewrap" style="max-height:40vh">
              <!-- usuarios -->
            </div>
          </div>
        </div>

      </div><!-- /adminBox -->
    </div>
  </div>

  <div id="toast" class="toast">Hecho</div>

  <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.8.1/dist/socket.io.min.js" crossorigin="anonymous"></script>

  <script>
/* ========= Utils ========= */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const toast=m=>{const t=$('#toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2200);};
function escapeHtml(s){return (s??"").toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#039;");}
function humanUntil(ms){const s=Math.max(0,Math.floor((ms-Date.now())/1000));const h=Math.floor(s/3600),m=Math.floor((s%3600)/60),sc=s%60;return h>0?`${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${sc.toString().padStart(2,'0')}`:`${m.toString().padStart(2,'0')}:${sc.toString().padStart(2,'0')}`}

/* ========= Local UI lists ========= */
const LS_CHALLENGES='arq.challenges.v2', LS_RESULTS='arq.results.v1';
let challenges=load(LS_CHALLENGES,[]), results=load(LS_RESULTS,{});
function load(k,def){try{return JSON.parse(localStorage.getItem(k))??def}catch{return def}}
function save(k,v){localStorage.setItem(k,JSON.stringify(v))}

/* Combinaciones */
const COMBOS = [
  // B√°sicos
  { id:'H2O',      code:'H‚ÇÇO',  name:'Agua',                    color:'#66CCFF' },
  { id:'NACL',     code:'NaCl', name:'Sal de mesa',             color:'#E0F7FA' },
  { id:'CO2',      code:'CO‚ÇÇ',  name:'Di√≥xido de carbono',      color:'#CFCFCF' },
  { id:'CO',       code:'CO',   name:'Mon√≥xido de carbono',     color:'#CFCFCF' },
  { id:'NH3',      code:'NH‚ÇÉ',  name:'Amon√≠aco',                color:'#ECEFF1' },
  { id:'H2O2',     code:'H‚ÇÇO‚ÇÇ', name:'Per√≥xido de hidr√≥geno',   color:'#BFE9FF' },

  // √Åcidos (halh√≠dricos y otros que listaste)
  { id:'ACIDO_CLORHIDRICO', code:'HCl', name:'√Åcido clorh√≠drico', color:'#FFECEC' },
  { id:'ACIDO_BROMHIDRICO', code:'HBr', name:'√Åcido bromh√≠drico', color:'#FFECEC' },
  { id:'ACIDO_YODHIDRICO',  code:'HI',  name:'√Åcido yodh√≠drico',  color:'#FFECEC' },
  { id:'SULFURO_DE_HIDROGENO', code:'H‚ÇÇS', name:'Sulfuro de hidr√≥geno', color:'#FFFDE7' },

  // √ìxidos (todos los de tus listas)
  { id:'OXIDO_FERRICO',     code:'Fe‚ÇÇO‚ÇÉ', name:'√ìxido f√©rrico',     color:'#CFCFCF' },
  { id:'OXIDO_FERROSO',     code:'FeO',   name:'√ìxido ferroso',      color:'#CFCFCF' },
  { id:'OXIDO_DE_MAGNESIO', code:'MgO',   name:'√ìxido de magnesio',  color:'#CFCFCF' },
  { id:'OXIDO_DE_CALCIO',   code:'CaO',   name:'√ìxido de calcio',    color:'#CFCFCF' },
  { id:'OXIDO_DE_ALUMINIO', code:'Al‚ÇÇO‚ÇÉ', name:'√ìxido de aluminio',  color:'#CFCFCF' },
  { id:'OXIDO_DE_ZINC',     code:'ZnO',   name:'√ìxido de zinc',      color:'#CFCFCF' },
  { id:'OXIDO_DE_PLOMO',    code:'PbO',   name:'√ìxido de plomo',     color:'#CFCFCF' },
  { id:'OXIDO_DE_URANIO',   code:'',      name:'√ìxido de uranio',    color:'#CFCFCF' },
  { id:'OXIDO_DE_COBRE',    code:'CuO',   name:'√ìxido de cobre',     color:'#CFCFCF' },
  { id:'OXIDO_DE_POTASIO',  code:'K‚ÇÇO',   name:'√ìxido de potasio',   color:'#CFCFCF' },
  { id:'OXIDO_DE_SODIO',    code:'Na‚ÇÇO',  name:'√ìxido de sodio',     color:'#CFCFCF' },
  { id:'OXIDO_DE_ESTRONCIO',code:'SrO',   name:'√ìxido de estroncio', color:'#CFCFCF' },
  { id:'OXIDO_DE_BARIO',    code:'BaO',   name:'√ìxido de bario',     color:'#CFCFCF' },
  { id:'OXIDO_DE_TITANIO',  code:'TiO‚ÇÇ',  name:'√ìxido de titanio',   color:'#CFCFCF' },
  { id:'OXIDO_DE_CROMO',    code:'Cr‚ÇÇO‚ÇÉ', name:'√ìxido de cromo',     color:'#CFCFCF' },
  { id:'DIOXIDO_DE_MANGANESO', code:'MnO‚ÇÇ', name:'Di√≥xido de manganeso', color:'#CFCFCF' },
  { id:'OXIDO_DE_NIQUEL',   code:'NiO',   name:'√ìxido de n√≠quel',    color:'#CFCFCF' },
  { id:'OXIDO_DE_COBALTO',  code:'CoO',   name:'√ìxido de cobalto',   color:'#CFCFCF' },
  { id:'OXIDO_DE_PLATA',    code:'Ag‚ÇÇO',  name:'√ìxido de plata',     color:'#CFCFCF' },
  { id:'OXIDO_DE_MERCURIO', code:'HgO',   name:'√ìxido de mercurio',  color:'#CFCFCF' },
  { id:'OXIDO_DE_ESTANO',   code:'SnO',   name:'√ìxido de esta√±o',    color:'#CFCFCF' },
  { id:'OXIDO_DE_CADMIO',   code:'CdO',   name:'√ìxido de cadmio',    color:'#CFCFCF' },
  { id:'OXIDO_NITRICO',     code:'NO',    name:'√ìxido n√≠trico',      color:'#CFCFCF' },
  { id:'DIOXIDO_DE_NITROGENO', code:'NO‚ÇÇ', name:'Di√≥xido de nitr√≥geno', color:'#CFCFCF' },
  { id:'DIOXIDO_DE_AZUFRE',    code:'SO‚ÇÇ', name:'Di√≥xido de azufre',    color:'#CFCFCF' },
  { id:'TRIOXIDO_DE_AZUFRE',   code:'SO‚ÇÉ', name:'Tri√≥xido de azufre',   color:'#CFCFCF' },
  { id:'DIOXIDO_DE_CARBONO',   code:'CO‚ÇÇ', name:'Di√≥xido de carbono',   color:'#CFCFCF' },

  // Hidruros (los de tu lista)
  { id:'HIDRURO_DE_SODIO',   code:'NaH',  name:'Hidruro de sodio',   color:'#ECEFF1' },
  { id:'HIDRURO_DE_LITIO',   code:'LiH',  name:'Hidruro de litio',   color:'#ECEFF1' },
  { id:'HIDRURO_DE_CALCIO',  code:'CaH‚ÇÇ', name:'Hidruro de calcio',  color:'#ECEFF1' },
  { id:'HIDRURO_DE_MAGNESIO',code:'MgH‚ÇÇ', name:'Hidruro de magnesio',color:'#ECEFF1' },
  { id:'HIDRURO_DE_ALUMINIO',code:'AlH‚ÇÉ', name:'Hidruro de aluminio',color:'#ECEFF1' },

  // Cloruros (todos los que mostraste)
  { id:'CLORURO_DE_SODIO',    code:'NaCl',  name:'Cloruro de sodio',    color:'#E0F7FA' },
  { id:'CLORURO_DE_POTASIO',  code:'KCl',   name:'Cloruro de potasio',  color:'#E0F7FA' },
  { id:'CLORURO_DE_LITIO',    code:'LiCl',  name:'Cloruro de litio',    color:'#E0F7FA' },
  { id:'CLORURO_DE_BERILIO',  code:'BeCl‚ÇÇ', name:'Cloruro de berilio',  color:'#E0F7FA' },
  { id:'CLORURO_DE_CALCIO',   code:'CaCl‚ÇÇ', name:'Cloruro de calcio',   color:'#E0F7FA' },
  { id:'CLORURO_DE_MAGNESIO', code:'MgCl‚ÇÇ', name:'Cloruro de magnesio', color:'#E0F7FA' },
  { id:'CLORURO_DE_ALUMINIO', code:'AlCl‚ÇÉ', name:'Cloruro de aluminio', color:'#E0F7FA' },
  { id:'CLORURO_FERROSO',     code:'FeCl‚ÇÇ', name:'Cloruro ferroso',     color:'#E0F7FA' },
  { id:'CLORURO_FERRICO',     code:'FeCl‚ÇÉ', name:'Cloruro f√©rrico',     color:'#E0F7FA' },
  { id:'CLORURO_CUPROSO',     code:'CuCl',  name:'Cloruro cuproso',     color:'#E0F7FA' },
  { id:'CLORURO_CUPRICO',     code:'CuCl‚ÇÇ', name:'Cloruro c√∫prico',     color:'#E0F7FA' },
  { id:'CLORURO_DE_PLATA',    code:'AgCl',  name:'Cloruro de plata',    color:'#E0F7FA' },
  { id:'CLORURO_DE_ESTANO',   code:'SnCl‚ÇÇ', name:'Cloruro de esta√±o',   color:'#E0F7FA' },
  { id:'CLORURO_DE_ORO',      code:'AuCl‚ÇÉ', name:'Cloruro de oro',      color:'#E0F7FA' },
  { id:'CLORURO_DE_MERCURIO', code:'HgCl‚ÇÇ', name:'Cloruro de mercurio', color:'#E0F7FA' },
  { id:'CLORURO_MERCURIOSO',  code:'Hg‚ÇÇCl‚ÇÇ',name:'Cloruro mercurioso',  color:'#E0F7FA' },
  { id:'CLORURO_DE_TITANIO',  code:'TiCl‚ÇÑ', name:'Cloruro de titanio',  color:'#E0F7FA' },
  { id:'CLORURO_DE_GALIO',    code:'GaCl‚ÇÉ', name:'Cloruro de galio',    color:'#E0F7FA' },
  { id:'CLORURO_DE_INDIO',    code:'InCl‚ÇÉ', name:'Cloruro de indio',    color:'#E0F7FA' },
  { id:'CLORURO_DE_TALIO',    code:'TlCl',  name:'Cloruro de talio',    color:'#E0F7FA' },

  // Fluoruros
  { id:'FLUORURO_DE_LITIO',   code:'LiF',  name:'Fluoruro de litio',   color:'#E8F5E9' },
  { id:'FLUORURO_DE_BERILIO', code:'BeF‚ÇÇ', name:'Fluoruro de berilio', color:'#E8F5E9' },
  { id:'FLUORURO_DE_CALCIO',  code:'CaF‚ÇÇ', name:'Fluoruro de calcio',  color:'#E8F5E9' },
  { id:'FLUORURO_DE_SODIO',   code:'NaF',  name:'Fluoruro de sodio',   color:'#E8F5E9' },
  { id:'FLUORURO_DE_POTASIO', code:'KF',   name:'Fluoruro de potasio', color:'#E8F5E9' },
  { id:'FLUORURO_DE_MAGNESIO',code:'MgF‚ÇÇ', name:'Fluoruro de magnesio',color:'#E8F5E9' },
  { id:'FLUORURO_DE_PLATA',   code:'AgF',  name:'Fluoruro de plata',   color:'#E8F5E9' },

  // Bromuros
  { id:'BROMURO_DE_SODIO',    code:'NaBr', name:'Bromuro de sodio',    color:'#FFF3E0' },
  { id:'BROMURO_DE_POTASIO',  code:'KBr',  name:'Bromuro de potasio',  color:'#FFF3E0' },
  { id:'BROMURO_DE_PLATA',    code:'AgBr', name:'Bromuro de plata',    color:'#FFF3E0' },
  { id:'BROMURO_DE_ALUMINIO', code:'AlBr‚ÇÉ',name:'Bromuro de aluminio', color:'#FFF3E0' },

  // Yoduros
  { id:'YODURO_DE_LITIO',     code:'LiI',  name:'Yoduro de litio',     color:'#F3E5F5' },
  { id:'YODURO_DE_SODIO',     code:'NaI',  name:'Yoduro de sodio',     color:'#F3E5F5' },
  { id:'YODURO_DE_MERCURIO',  code:'HgI‚ÇÇ', name:'Yoduro de mercurio',  color:'#F3E5F5' },
  { id:'YODURO_DE_ALUMINIO',  code:'AlI‚ÇÉ', name:'Yoduro de aluminio',  color:'#F3E5F5' },

  // Sulfuros
  { id:'SULFURO_DE_ZINC',     code:'ZnS',  name:'Sulfuro de zinc',     color:'#FFFDE7' },
  { id:'SULFURO_FERROSO',     code:'FeS',  name:'Sulfuro ferroso',     color:'#FFFDE7' },
  { id:'SULFURO_DE_SODIO',    code:'Na2S', name:'Sulfuro de sodio',    color:'#FFFDE7' },
  { id:'SULFURO_DE_PLOMO',    code:'PbS',  name:'Sulfuro de plomo',    color:'#FFFDE7' },
  { id:'SULFURO_DE_CADMIO',   code:'CdS',  name:'Sulfuro de cadmio',   color:'#FFFDE7' },
  { id:'SULFURO_DE_NIQUEL',   code:'NiS',  name:'Sulfuro de n√≠quel',   color:'#FFFDE7' },
  { id:'SULFURO_DE_COBALTO',  code:'CoS',  name:'Sulfuro de cobalto',  color:'#FFFDE7' },
  { id:'SULFURO_DE_PLATA',    code:'Ag2S', name:'Sulfuro de plata',    color:'#FFFDE7' },
  { id:'SULFURO_DE_MERCURIO', code:'HgS',  name:'Sulfuro de mercurio', color:'#FFFDE7' },

  // Carbonatos / otros
  { id:'CARBONATO_DE_CALCIO', code:'CaCO‚ÇÉ', name:'Carbonato de calcio', color:'#F5F5F5' },
];



/* UI ‚Üí fusion_id */
const FUSION_ID_MAP = {
  // B√°sicos
  H2O:'agua',
  NACL:'sal_de_mesa',
  CO2:'dioxido_de_carbono',
  CO:'monoxido_de_carbono',
  NH3:'amoniaco',
  H2O2:'peroxido_de_hidrogeno',

  // √Åcidos
  ACIDO_CLORHIDRICO:'acido_clorhidrico',
  ACIDO_BROMHIDRICO:'acido_bromhidrico',
  ACIDO_YODHIDRICO:'acido_yodhidrico',
  SULFURO_DE_HIDROGENO:'sulfuro_de_hidrogeno',

  // √ìxidos
  OXIDO_FERRICO:'oxido_ferrico',
  OXIDO_FERROSO:'oxido_ferroso',
  OXIDO_DE_MAGNESIO:'oxido_de_magnesio',
  OXIDO_DE_CALCIO:'oxido_de_calcio',
  OXIDO_DE_ALUMINIO:'oxido_de_aluminio',
  OXIDO_DE_ZINC:'oxido_de_zinc',
  OXIDO_DE_PLOMO:'oxido_de_plomo',
  OXIDO_DE_URANIO:'oxido_de_uranio',
  OXIDO_DE_COBRE:'oxido_de_cobre',
  OXIDO_DE_POTASIO:'oxido_de_potasio',
  OXIDO_DE_SODIO:'oxido_de_sodio',
  OXIDO_DE_ESTRONCIO:'oxido_de_estroncio',
  OXIDO_DE_BARIO:'oxido_de_bario',
  OXIDO_DE_TITANIO:'oxido_de_titanio',
  OXIDO_DE_CROMO:'oxido_de_cromo',
  DIOXIDO_DE_MANGANESO:'dioxido_de_manganeso',
  OXIDO_DE_NIQUEL:'oxido_de_niquel',
  OXIDO_DE_COBALTO:'oxido_de_cobalto',
  OXIDO_DE_PLATA:'oxido_de_plata',
  OXIDO_DE_MERCURIO:'oxido_de_mercurio',
  OXIDO_DE_ESTANO:'oxido_de_estano',
  OXIDO_DE_CADMIO:'oxido_de_cadmio',
  OXIDO_NITRICO:'oxido_nitrico',
  DIOXIDO_DE_NITROGENO:'dioxido_de_nitrogeno',
  DIOXIDO_DE_AZUFRE:'dioxido_de_azufre',
  TRIOXIDO_DE_AZUFRE:'trioxido_de_azufre',
  DIOXIDO_DE_CARBONO:'dioxido_de_carbono',

  // Hidruros
  HIDRURO_DE_SODIO:'hidruro_de_sodio',
  HIDRURO_DE_LITIO:'hidruro_de_litio',
  HIDRURO_DE_CALCIO:'hidruro_de_calcio',
  HIDRURO_DE_MAGNESIO:'hidruro_de_magnesio',
  HIDRURO_DE_ALUMINIO:'hidruro_de_aluminio',

  // Cloruros
  CLORURO_DE_SODIO:'cloruro_de_sodio',
  CLORURO_DE_POTASIO:'cloruro_de_potasio',
  CLORURO_DE_LITIO:'cloruro_de_litio',
  CLORURO_DE_BERILIO:'cloruro_de_berilio',
  CLORURO_DE_CALCIO:'cloruro_de_calcio',
  CLORURO_DE_MAGNESIO:'cloruro_de_magnesio',
  CLORURO_DE_ALUMINIO:'cloruro_de_aluminio',
  CLORURO_FERROSO:'cloruro_ferroso',
  CLORURO_FERRICO:'cloruro_ferrico',
  CLORURO_CUPROSO:'cloruro_cuproso',
  CLORURO_CUPRICO:'cloruro_cuprico',
  CLORURO_DE_PLATA:'cloruro_de_plata',
  CLORURO_DE_ESTANO:'cloruro_de_estano',
  CLORURO_DE_ORO:'cloruro_de_oro',
  CLORURO_DE_MERCURIO:'cloruro_de_mercurio',
  CLORURO_MERCURIOSO:'cloruro_mercurioso',
  CLORURO_DE_TITANIO:'cloruro_de_titanio',
  CLORURO_DE_GALIO:'cloruro_de_galio',
  CLORURO_DE_INDIO:'cloruro_de_indio',
  CLORURO_DE_TALIO:'cloruro_de_talio',

  // Fluoruros
  FLUORURO_DE_LITIO:'fluoruro_de_litio',
  FLUORURO_DE_BERILIO:'fluoruro_de_berilio',
  FLUORURO_DE_CALCIO:'fluoruro_de_calcio',
  FLUORURO_DE_SODIO:'fluoruro_de_sodio',
  FLUORURO_DE_POTASIO:'fluoruro_de_potasio',
  FLUORURO_DE_MAGNESIO:'fluoruro_de_magnesio',
  FLUORURO_DE_PLATA:'fluoruro_de_plata',

  // Bromuros
  BROMURO_DE_SODIO:'bromuro_de_sodio',
  BROMURO_DE_POTASIO:'bromuro_de_potasio',
  BROMURO_DE_PLATA:'bromuro_de_plata',
  BROMURO_DE_ALUMINIO:'bromuro_de_aluminio',

  // Yoduros
  YODURO_DE_LITIO:'yoduro_de_litio',
  YODURO_DE_SODIO:'yoduro_de_sodio',
  YODURO_DE_MERCURIO:'yoduro_de_mercurio',
  YODURO_DE_ALUMINIO:'yoduro_de_aluminio',

  // Sulfuros
  SULFURO_DE_ZINC:'sulfuro_de_zinc',
  SULFURO_FERROSO:'sulfuro_ferroso',
  SULFURO_DE_SODIO:'sulfuro_de_sodio',
  SULFURO_DE_PLOMO:'sulfuro_de_plomo',
  SULFURO_DE_CADMIO:'sulfuro_de_cadmio',
  SULFURO_DE_NIQUEL:'sulfuro_de_niquel',
  SULFURO_DE_COBALTO:'sulfuro_de_cobalto',
  SULFURO_DE_PLATA:'sulfuro_de_plata',
  SULFURO_DE_MERCURIO:'sulfuro_de_mercurio',

  // Carbonatos/otros
  CARBONATO_DE_CALCIO:'carbonato_de_calcio',
};


/* ========= Endpoints ========= */
const API_BASE="https://ar-back.onrender.com";
const EP={
  listChallenges:`${API_BASE}/challenges`,
  activeChallenges:`${API_BASE}/challenges/active`,
  createChallenge:`${API_BASE}/challenges`,
  expireOthers:`${API_BASE}/challenges/expire_others`,
  challengeById:id=>`${API_BASE}/challenges/${id}`,
  deleteChallenge:id=>`${API_BASE}/challenges/${id}`,
  resultsPreferred:id=>`${API_BASE}/challenges/${id}/results`,
  resultsAlt1:id=>`${API_BASE}/scores/by_challenge/${id}`,
  resultsAlt2:id=>`${API_BASE}/scores/by_challenge?challenge_id=${id}`
  users: `${API_BASE}/users`,
};

/* ===== Auth para admin (BEARER) ===== */
const ADMIN_TOKEN_CLIENT = 'changeme'; // <-- igual que ADMIN_TOKEN en Render
let CURRENT_USER = null;
let IS_ADMIN = false;             // solo para desbloquear la UI
let LAST_USERS = [];

function adminHeaders(extra={}) {
  return {
    'Content-Type':'application/json',
    'Authorization': `Bearer ${ADMIN_TOKEN_CLIENT}`,
    ...extra
  };
}

/* ========= Portada ========= */
function renderActiveChallenges(){
  const root=$('#activeChallenges'); root.innerHTML='';
  const active=challenges.filter(c=>c.expiresAt>Date.now());
  if(!active.length){root.innerHTML='<div class="hint">No hay desaf√≠os activos por ahora.</div>'; return;}
  active.forEach(c=>{
    const combo=COMBOS.find(x=>x.id===c.comboId);
    const el=document.createElement('div');
    el.style.cssText='border:1px solid #2e3a75;border-radius:12px;padding:12px;background:linear-gradient(180deg,#0f183a,#121f49);';
    el.innerHTML=`
      <div class="row" style="margin-bottom:6px">
        <div style="font-weight:800">${combo?.code||c.comboId}</div>
        <span class="badge">+${c.points} pts</span>
      </div>
      <div style="font-size:13px;color:#cfe0ff;margin-bottom:6px">${c.title||combo?.name||'Combinaci√≥n'}</div>
      <div class="row">
        <div style="display:flex;gap:8px;align-items:center">
          <div class="dot" style="background:${combo?.color||'#7AE7FF'}"></div>
          <small>${combo?.name||'-'}</small>
        </div>
        <div class="badge" data-countdown="${c.id}">--:--</div>
      </div>`;
    root.appendChild(el);
  });
}
function tick(){
  $$('#activeChallenges [data-countdown]').forEach(el=>{
    const c=challenges.find(x=>x.id===el.dataset.countdown); if(!c)return;
    if(c.expiresAt<=Date.now()){renderActiveChallenges(); save(LS_CHALLENGES,challenges);}
    else el.textContent=humanUntil(c.expiresAt);
  });
}
setInterval(tick,1000);

/* ========= Admin: lista desde servidor ========= */
$('#btnRefreshChallenges')?.addEventListener('click', loadServerChallenges);
$('#btnCloseDetail')?.addEventListener('click', ()=>$('#serverChallengeDetail').classList.add('hidden'));

async function httpJson(url,opt={}) {
  const res=await fetch(url,{mode:'cors',cache:'no-store',...opt});
  if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
  const ct=res.headers.get('content-type')||'';
  return ct.includes('application/json')?res.json():res.text();
}

function parseUntilVal(v){
  const now=Date.now();
  if(v==='2d')return now+2*24*60*60*1000;
  if(v==='3d')return now+3*24*60*60*1000;
  if(v.endsWith('m'))return now+Number(v.replace('m',''))*60*1000;
  if(v.endsWith('h'))return now+Number(v.replace('h',''))*60*60*1000;
  return now+60*60*1000;
}

/* Publicar al backend */
$('#btnAddChallenge')?.addEventListener('click', publishChallenge);
async function publishChallenge(){
  try{
    // ‚úÖ Nueva validaci√≥n: login obligatorio
    if (!CURRENT_USER) {
      toast('Debes iniciar sesi√≥n como docente antes de publicar');
      return;
    }

    const title=($('#dName').value||'').trim();
    const points=Math.max(1,Number($('#pts').value||100));
    const count =Math.max(1,Number($('#count').value||1));

    let expiresAtMs;
    const dur=$('#dur').value;
    if(dur==='custom'){
      const dt=$('#customUntil').value;
      if(!dt){ toast('Elige fecha/hora'); return; }
      expiresAtMs=new Date(dt).getTime();
    } else {
      expiresAtMs=parseUntilVal(dur);
    }
    if(expiresAtMs<=Date.now()){ toast('La expiraci√≥n debe ser en el futuro'); return; }

    const duration_minutes = Math.max(1, Math.ceil((expiresAtMs - Date.now())/60000));

    const checked=[...$('#comboList').querySelectorAll('input:checked')].map(i=>i.value);
    if(!checked.length){ toast('Selecciona al menos una combinaci√≥n'); return; }
    const chosenUI=checked.length>count?randPick(checked,count):checked;
    const fusion_ids=chosenUI.map(k=>FUSION_ID_MAP[k]).filter(Boolean);
    if(!fusion_ids.length){ toast('Las combinaciones no tienen mapeo en backend'); return; }

    const created=await httpJson(EP.createChallenge,{
      method:'POST',
      headers:adminHeaders(),
      body:JSON.stringify({
        name:title||'Desaf√≠o',
        points_per_combo:points,
        required_count:count,
        duration_minutes,
        fusion_ids
      })
    });

    const keepId = created?.id;
    if(($('#expireOthers')?.checked ?? true) && keepId){
      try{
        await httpJson(EP.expireOthers,{
          method:'POST',
          headers:adminHeaders(),
          body:JSON.stringify({ keep_id: keepId })
        });
      }catch(e){ console.warn('expire_others:',e); }
    }

    const uiId=(crypto.randomUUID?crypto.randomUUID():String(Date.now())+Math.random());
    challenges.push({id:uiId,comboId:chosenUI[0],points,expiresAt:expiresAtMs,title});
    save(LS_CHALLENGES,challenges);
    renderActiveChallenges();

    await loadServerChallenges();
    toast('Desaf√≠o publicado');
  }catch(e){ console.error(e); toast('Error publicando: '+e.message); }
}

function randPick(arr,n){const a=[...arr],o=[];while(a.length&&o.length<n){o.push(a.splice(Math.random()*a.length|0,1)[0]);}return o;}

/* Cargar lista servidor */
async function loadServerChallenges(){
  const box=$('#serverChallengeList');
  box.innerHTML='<div class="hint">Cargando‚Ä¶</div>';
  try{
    let list=await httpJson(EP.listChallenges).catch(async()=>httpJson(EP.activeChallenges));
    if(!Array.isArray(list)) list=list?[list]:[];
    const now=new Date();
    list=list.filter(c=>!c.expires_at||new Date(c.expires_at)>now);

    if(!list.length){ box.innerHTML='<div class="hint">No hay desaf√≠os activos en el servidor.</div>'; return; }

    box.innerHTML=list.map(c=>{
      const combos=(c.fusion_ids||[]).map(fid=>`<span class="badge" title="${fid}">${fid}</span>`).join(' ');
      const exp=c.expires_at?new Date(c.expires_at).toLocaleString():'‚Äî';
      return `<div class="cardLine">
        <div>
          <div style="font-weight:800">${escapeHtml(c.name||'Desaf√≠o')}</div>
          <div class="hint">+${c.points_per_combo||0} pts ¬∑ Exigir: ${c.required_count||1} ¬∑ Exp: ${exp}</div>
          <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap">${combos||'<span class="badge">sin combinaciones</span>'}</div>
        </div>
        <div class="tools">
          <button class="btn small" data-open="${c.id}">Abrir</button>
          <button class="btn small ghost" data-del="${c.id}">Eliminar</button>
        </div>
      </div>`;
    }).join('');

    box.querySelectorAll('[data-open]').forEach(b=>b.onclick=()=>openServerChallengeDetail(list.find(x=>String(x.id)===String(b.dataset.open))));
    box.querySelectorAll('[data-del]').forEach(b=>b.onclick=()=>deleteServerChallenge(b.dataset.del));
  }catch(e){
    console.error(e);
    box.innerHTML=`<div class="hint">No se pudo cargar: ${escapeHtml(e.message)}</div>`;
  }
}

/* Eliminar */
async function deleteServerChallenge(id){
  if(!confirm('¬øEliminar este desaf√≠o?')) return;
  try{
    await httpJson(EP.deleteChallenge(id),{method:'DELETE',headers:adminHeaders()});
    toast('Desaf√≠o eliminado');
    await loadServerChallenges();
    $('#serverChallengeDetail').classList.add('hidden');
  }catch(e){ console.error(e); toast('No se pudo eliminar: '+e.message); }
}

/* Detalle + participantes */
async function openServerChallengeDetail(ch){
  if(!ch) return;
  const detail=$('#serverChallengeDetail');
  const head=$('#detailHeader');
  const tbody=$('#tbodyChResults');
  detail.classList.remove('hidden');

  const exp=ch.expires_at?new Date(ch.expires_at).toLocaleString():'‚Äî';
  const combos=(ch.fusion_ids||[]).map(fid=>`<span class="badge" title="${fid}">${fid}</span>`).join(' ');
  head.innerHTML=`
    <div class="row" style="gap:10px">
      <div>
        <div style="font-weight:800;font-size:18px">${escapeHtml(ch.name||'Desaf√≠o')}</div>
        <div class="kv" style="margin-top:8px">
          <b>Puntos por combo</b><div>${ch.points_per_combo||0}</div>
          <b>Cantidad a exigir</b><div>${ch.required_count||1}</div>
          <b>Expira</b><div>${exp}</div>
          <b>Combinaciones</b><div style="display:flex;gap:6px;flex-wrap:wrap">${combos||'-'}</div>
        </div>
      </div>
      <div><button class="btn small ghost" onclick="deleteServerChallenge(${JSON.stringify(ch.id)})">Eliminar</button></div>
    </div>`;

  tbody.innerHTML='<tr><td colspan="4" class="hint">Cargando‚Ä¶</td></tr>';
  try{
    let rows;
    try{ rows=await httpJson(EP.resultsPreferred(ch.id)); }
    catch{ try{ rows=await httpJson(EP.resultsAlt1(ch.id)); }
    catch{ rows=await httpJson(EP.resultsAlt2(ch.id)); } }

    if(!Array.isArray(rows)||!rows.length){
      tbody.innerHTML='<tr><td colspan="4" class="hint">A√∫n no hay respuestas para este desaf√≠o.</td></tr>';
      return;
    }
    rows=rows.sort((a,b)=>(b.score||0)-(a.score||0)||(a.name||'').localeCompare(b.name||''));
    tbody.innerHTML=rows.map((r,i)=>{
      const medal=i===0?'ü•á ':i===1?'ü•à ':i===2?'ü•â ':'';
      return `<tr><td class="rank">${medal}${i+1}</td><td class="name">${escapeHtml(r.name||'-')}</td><td class="score">${r.score??0}</td><td>${escapeHtml(r.class||r.course||'-')}</td></tr>`;
    }).join('');
  }catch(e){
    console.error(e);
    tbody.innerHTML=`<tr><td colspan="4" class="hint">No se pudieron cargar los resultados: ${escapeHtml(e.message)}</td></tr>`;
  }
}

/* ========= B√∫squeda combos ========= */
function renderComboList(){
  const wrap=$('#comboList'); if(!wrap) return;
  const term=($('#comboSearch')?.value||'').trim().toLowerCase();
  const list=COMBOS.filter(c=>!term||c.id.toLowerCase().includes(term)||c.code.toLowerCase().includes(term)||c.name.toLowerCase().includes(term));
  wrap.innerHTML=list.map(c=>`
    <label class="combo-item"><input type="checkbox" value="${c.id}"/>
      <span class="dot" style="background:${c.color}"></span>
      <span><strong>${c.code}</strong> ‚Äî ${c.name}</span>
    </label>`).join('')||`<div class="hint">Sin resultados para ‚Äú${term}‚Äù.</div>`;
}
$('#comboSearch')?.addEventListener('input',renderComboList);

/* ========= Resultados demo ========= */
function renderResultsIndex(){
  const wrap=$('#resultsIndex'); if(!wrap) return;
  $('#resultDetail').classList.add('hidden'); wrap.classList.remove('hidden');
  if(!challenges.length){wrap.innerHTML='<div class="hint">No hay desaf√≠os creados.</div>'; return;}
  wrap.innerHTML=challenges.slice().sort((a,b)=>b.expiresAt-a.expiresAt).map(c=>{
    const combo=COMBOS.find(x=>x.id===c.comboId);
    const arr=(results[c.id]||[]).slice().sort((a,b)=>b.score-a.score);
    const best=arr[0]?.score ?? 0;
    const state=c.expiresAt>Date.now()?'Activo':'Vencido';
    return `<div class="cardLine">
      <div style="display:flex;align-items:center;gap:10px">
        <div class="dot" style="background:${combo?.color||'#7AE7FF'}"></div>
        <div>
          <div style="font-weight:800">${c.title||combo?.name||'Desaf√≠o'} ¬∑ ${combo?.code||c.comboId}</div>
          <div class="hint">${state} ¬∑ Exp: ${new Date(c.expiresAt).toLocaleString()} ¬∑ Mejor puntaje: ${best}</div>
        </div>
      </div>
      <button class="btn small" data-open="${c.id}">Abrir</button>
    </div>`;
  }).join('');
  wrap.querySelectorAll('[data-open]').forEach(b=>b.onclick=()=>openResultsDetail(b.dataset.open));
}
function openResultsDetail(chId){
  const c=challenges.find(x=>x.id===chId); if(!c) return;
  const combo=COMBOS.find(x=>x.id===c.comboId);
  const arr=(results[chId]||[]).slice().sort((a,b)=>b.score-a.score||a.name.localeCompare(b.name));
  $('#resultsIndex').classList.add('hidden'); $('#resultDetail').classList.remove('hidden');
  $('#resultHeader').innerHTML=`<div class="row" style="gap:10px">
    <div class="dot" style="background:${combo?.color||'#7AE7FF'}"></div>
    <div><div style="font-weight:800">${c.title||combo?.name||'Desaf√≠o'} ¬∑ ${combo?.code||c.comboId}</div>
    <div class="hint">Expira: ${new Date(c.expiresAt).toLocaleString()} ¬∑ +${c.points} pts ¬∑ ${(results[chId]||[]).length} resultado(s)</div></div></div>`;
  const tb=$('#tbodyResults'); tb.innerHTML='';
  arr.forEach((r,i)=>{
    const medal=i===0?'ü•á ':i===1?'ü•à ':i===2?'ü•â ':'';
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="rank">${medal}${i+1}</td><td class="name">${escapeHtml(r.name)}</td><td class="score">${r.score}</td><td>${r.class||'-'}</td>`;
    tb.appendChild(tr);
  });
  $('#btnBackResults').onclick=()=>{ $('#resultDetail').classList.add('hidden'); $('#resultsIndex').classList.remove('hidden'); };
}

/* ========= Ranking live ========= */
const rankStatus=document.getElementById("rankStatus");
const tbody=document.getElementById("tbody");
const loadMoreWrap=document.getElementById("loadMoreWrap");
const btnMore=document.getElementById("btnMore");
let topRows=[]; let currentLimit=20; let socket=null;

function setRankStatus(msg){ if(rankStatus) rankStatus.textContent=msg; }
function renderRanking(){
  const rows=[...topRows].sort((a,b)=>b.score-a.score || a.name.localeCompare(b.name));
  tbody.innerHTML='';
  rows.forEach((r,i)=>{
    const medal=i===0?'ü•á ': i===1?'ü•à ': i===2?'ü•â ':''; 
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="rank">${medal}${i+1}</td><td class="name">${escapeHtml(r.name)}</td><td class="score">${r.score}</td>`;
    tbody.appendChild(tr);
  });
  loadMoreWrap.classList.toggle('hidden', rows.length < currentLimit);
}
async function fetchTopHTTP(n){
  const res=await fetch(`${API_BASE}/scores/top?n=${n}`,{cache:"no-store",mode:"cors"});
  if(!res.ok) throw new Error(res.status+" "+res.statusText);
  return res.json();
}
function startLiveSocket(){
  try{
    socket && socket.disconnect();
    socket=io(API_BASE,{transports:["websocket"],withCredentials:false});
    socket.on("connect",()=>setRankStatus("Conectado en vivo ‚úÖ"));
    socket.on("disconnect",()=>setRankStatus("Desconectado, reconectando‚Ä¶"));
    const ask=()=>socket.emit("get_top", currentLimit);
    socket.on("connect", ask);
    socket.on("top", rows=>{ topRows=rows||[]; renderRanking(); });
    socket.on("top_updated", rows=>{ topRows=rows||[]; renderRanking(); });
  }catch(e){ console.error(e); }
}
btnMore?.addEventListener('click', async ()=>{
  currentLimit += 50;
  try{
    topRows = await fetchTopHTTP(currentLimit);
    renderRanking();
    socket?.emit("get_top", currentLimit);
  }catch(e){ console.warn(e); }
});

/* ========= Init ========= */
function renderComboListInit(){ renderComboList(); }
function renderActiveInit(){ renderActiveChallenges(); }
function resultsLocalInit(){ renderResultsIndex(); }
(function init(){
  renderComboListInit();
  renderActiveInit();
  resultsLocalInit();
  (async ()=>{
    try{
      setRankStatus("Cargando top‚Ä¶");
      topRows = await fetchTopHTTP(currentLimit);
      renderRanking();
      setRankStatus("Conectando en vivo‚Ä¶");
    }catch(e){ setRankStatus("No se pudo cargar: "+e.message); }
    startLiveSocket();
    loadServerChallenges();
  })();
})();

/* ========= Login admin modal ========= */
/* ========= Login admin modal ========= */
const ovl = $('#ovl');

function updateLoginUI() {
  const userInput = $('#loginUser');
  const passInput = $('#loginPass');
  const who = $('#whoLine');
  const btn = $('#btnUnlock');

  if (CURRENT_USER) {
    // Logueado
    if (userInput) {
      userInput.value = CURRENT_USER.username || CURRENT_USER.name || '';
      userInput.disabled = true;
    }
    if (passInput) {
      passInput.value = '';
      passInput.classList.add('hidden'); // ocultamos el recuadro de contrase√±a
    }
    if (btn) btn.textContent = 'Cerrar sesi√≥n';

    if (who) {
      const labelRole = IS_ADMIN ? 'administrador' : (CURRENT_USER.role || 'docente');
      who.textContent = `Sesi√≥n iniciada como ${CURRENT_USER.name || CURRENT_USER.username} (${labelRole})`;
      who.classList.remove('hidden');
    }

    $('#adminBox').classList.remove('hidden');
    if (IS_ADMIN) {
      $('#usersSection')?.classList.remove('hidden');
    } else {
      $('#usersSection')?.classList.add('hidden');
    }

  } else {
    // No logueado
    if (userInput) {
      userInput.value = '';
      userInput.disabled = false;
    }
    if (passInput) {
      passInput.value = '';
      passInput.classList.remove('hidden');
    }
    if (btn) btn.textContent = 'Iniciar sesi√≥n';

    if (who) {
      who.textContent = '';
      who.classList.add('hidden');
    }

    $('#adminBox').classList.add('hidden');
    $('#usersSection')?.classList.add('hidden');
  }
}


$('#btnDocentes').onclick = () => {
  ovl.classList.add('show');

  // üßπ Limpiar campos
  $('#loginUser').value = '';
  $('#loginPass').value = '';

  // üëÅ Resetear visibilidad del password
  $('#loginPass').type = 'password';
  $('#toggleLoginPass').textContent = 'üëÅ';

  // üîí Ocultar paneles internos
  $('#adminBox').classList.add('hidden');
  $('#usersSection')?.classList.add('hidden');
  $('#whoLine')?.classList.add('hidden');

  // üîÑ Mostrar UI seg√∫n si hay login o no
  updateLoginUI();
};

$('#closeOvl').onclick = () => ovl.classList.remove('show');


$('#btnUnlock').onclick = async () => {
  // Si ya hay usuario -> CERRAR SESI√ìN
  if (CURRENT_USER) {
    CURRENT_USER = null;
    IS_ADMIN = false;
    toast('Sesi√≥n cerrada');
    updateLoginUI();
    return;
  }

  // Si no hay usuario -> INICIAR SESI√ìN
  const username = ($('#loginUser').value || '').trim();
  const password = ($('#loginPass').value || '').trim();

  if (!username || !password) {
    toast('Ingresa usuario y contrase√±a');
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/auth/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    });

    const data = await res.json().catch(() => ({}));

    if (!res.ok || !data.ok) {
      toast(data?.error || 'No se pudo iniciar sesi√≥n');
      CURRENT_USER = null;
      IS_ADMIN = false;
      updateLoginUI();
      return;
    }

    CURRENT_USER = data.user;
    IS_ADMIN = !!data.is_admin;

    if (IS_ADMIN) {
      loadUsers();
      toast('Modo administrador activado');
    } else {
      toast('Modo docente activado');
    }

    // Cargamos desaf√≠os desde el servidor estando logueado
    loadServerChallenges();
    updateLoginUI();

  } catch (e) {
    console.error(e);
    toast('Error de red al iniciar sesi√≥n');
  }
};



/* Mostrar/ocultar fecha custom */
$('#dur')?.addEventListener('change', ()=>{
  const show = $('#dur').value === 'custom';
  $('#customUntil').classList.toggle('hidden', !show);
});


// Ojito para ver/ocultar contrase√±a al crear docente
$('#toggleNewTeacherPass')?.addEventListener('click', () => {
  const input = $('#newTeacherPass');
  if (!input) return;
  const isPwd = input.type === 'password';
  input.type = isPwd ? 'text' : 'password';
  $('#toggleNewTeacherPass').textContent = isPwd ? 'üôà' : 'üëÅ';
});

/* ========= Gesti√≥n de usuarios (solo admin) ========= */

async function loadUsers() {
  if (!IS_ADMIN) return;

  const box = $('#usersList');
  if (!box) return;

  box.innerHTML = '<div class="hint">Cargando usuarios...</div>';

  try {
    const users = await httpJson(EP.users, {
      headers: adminHeaders()
    });

    LAST_USERS = users;

    box.innerHTML = `
      <table class="users-table" style="width: 100%">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Usuario</th>
            <th>Rol</th>
            <th>Activo</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          ${users.map(u => `
            <tr>
              <td>${escapeHtml(u.name || '')}</td>
              <td>${escapeHtml(u.username || '')}</td>
              <td>${escapeHtml(u.role || '')}</td>
              <td>
                <button class="btn small ghost" data-toggle-user="${u.id}">
                  ${u.active ? 'Desactivar' : 'Activar'}
                </button>
              </td>
              <td>
                <button class="btn small ghost" data-edit-user="${u.id}">
                  Editar
                </button>
                <button class="btn small danger" data-delete-user="${u.id}">
                  Eliminar
                </button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;

    // BOTONES: activar/desactivar
    box.querySelectorAll('[data-toggle-user]').forEach(btn => {
      btn.onclick = () => toggleUserActive(btn.dataset.toggleUser);
    });

    // BOTONES: editar usuario
    box.querySelectorAll('[data-edit-user]').forEach(btn => {
      btn.onclick = () => editUser(btn.dataset.editUser);
    });

    // BOTONES: borrar usuario
    box.querySelectorAll('[data-delete-user]').forEach(btn => {
      btn.onclick = () => deleteUser(btn.dataset.deleteUser);
    });

  } catch (e) {
    console.error("loadUsers error:", e);
    box.innerHTML = '<div class="hint">Error al cargar usuarios.</div>';
  }
}




async function toggleUserActive(id) {
  if (!IS_ADMIN) return;
  try {
    await fetch(`${API_BASE}/users/${id}`, {
      method: 'PATCH',
      headers: adminHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify({ toggleActive: true })
    });
    toast('Usuario actualizado');
    loadUsers();
  } catch (e) {
    console.error(e);
    toast('No se pudo actualizar el usuario');
  }
}
async function editUser(id) {
  if (!IS_ADMIN) return;

  const user = LAST_USERS?.find(u => String(u.id) === String(id));
  if (!user) {
    toast('Usuario no encontrado');
    return;
  }

  const newName = prompt('Nombre completo:', user.name || '');
  if (newName === null) return; // cancel√≥

  const newUsername = prompt('Usuario:', user.username || '');
  if (newUsername === null) return;

  const newRoleInput = prompt("Rol (admin / docente):", user.role || 'docente');
  if (newRoleInput === null) return;
  const newRole = (newRoleInput || '').trim().toLowerCase();
  if (newRole !== 'admin' && newRole !== 'docente') {
    toast('Rol inv√°lido, usa "admin" o "docente"');
    return;
  }

  const changePass = confirm('¬øQuieres cambiar la contrase√±a de este usuario?');
  let newPassword = null;
  if (changePass) {
    newPassword = prompt('Nueva contrase√±a (m√≠nimo 4 caracteres):', '');
    if (newPassword === null) return;
    if (newPassword.length < 4) {
      toast('La contrase√±a es muy corta');
      return;
    }
  }

  try {
    const body = {
      name: newName.trim(),
      username: newUsername.trim(),
      role: newRole   // ya validado
    };
    if (newPassword) body.password = newPassword;

    const res = await fetch(`${API_BASE}/users/${id}`, {
      method: 'PATCH',
      headers: adminHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify(body)
    });

    const data = await res.json().catch(() => ({}));

    if (!res.ok || !data.ok) {
      // aqu√≠ puedes mostrar errores espec√≠ficos, ej: username_duplicado
      if (data.error === 'username_duplicado') {
        toast('Ese usuario ya existe, prueba con otro nombre de usuario');
      } else {
        toast(data.error || 'No se pudo editar el usuario');
      }
      return;
    }

    toast('Usuario actualizado');
    loadUsers();
  } catch (e) {
    console.error(e);
    toast('No se pudo editar el usuario');
  }
}

async function deleteUser(id) {
  if (!IS_ADMIN) return;
  const user = LAST_USERS.find(u => String(u.id) === String(id));
  const name = user?.name || user?.username || 'este usuario';

  if (!confirm(`¬øSeguro que quieres eliminar a ${name}? Esta acci√≥n no se puede deshacer.`)) {
    return;
  }

  try {
    await fetch(`${API_BASE}/users/${id}`, {
      method: 'DELETE',
      headers: adminHeaders()
    });
    toast('Usuario eliminado');
    loadUsers();
  } catch (e) {
    console.error(e);
    toast('No se pudo eliminar el usuario');
  }
}


$('#btnReloadUsers')?.addEventListener('click', () => {
  if (IS_ADMIN) loadUsers();
});

$('#btnCreateTeacher')?.addEventListener('click', async () => {
  if (!IS_ADMIN) {
    toast('Solo el administrador puede crear usuarios');
    return;
  }

  const name = ($('#newTeacherName').value || '').trim();
  const username = ($('#newTeacherUser').value || '').trim();
  const password = ($('#newTeacherPass').value || '').trim();

  if (!name || !username || !password) {
    toast('Completa nombre, usuario y contrase√±a');
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/auth/register`, {
      method: 'POST',
      headers: adminHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify({ name, username, password, role: 'docente' })
    });

    const data = await res.json().catch(() => ({}));
    if (!res.ok || !data.ok) {
      toast(data?.error || 'No se pudo crear el docente');
      return;
    }

    $('#newTeacherName').value = '';
    $('#newTeacherUser').value = '';
    $('#newTeacherPass').value = '';

    $('#newTeacherPass').type = 'password';
    $('#toggleNewTeacherPass').textContent = 'üëÅ';


    toast('Docente creado correctamente');
    loadUsers();

  } catch (e) {
    console.error(e);
    toast('Error de red al crear docente');
  }
});

  </script>
</body>
</html>
